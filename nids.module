<?php
$GLOBALS['nids_dataset_fields'] = array(
  'overview' => array(
    'nichoirid',
    'userid',
    'typeobs',
    'obsval'
    ),
  );

/**
 * Implements hook_node_info().
 */
function nids_node_info() {
  $info = array();

  $info['nichoir'] = array(
    'name'        => t('nichoir'),
    'base'        => 'nichoir',
    'module'      => 'nids',
    'description' => t('Ajout observations nichoir.'),
    'has_body'    => FALSE
    );
  return $info;
}

function nids_init() {
  $module_path = base_path().drupal_get_path('module', 'nids');
  drupal_add_js(array(
    'nids_path' => $module_path,
    'nids_callback_base_url' => base_path().'nids'
    ), 'setting');
}

// Implementation of hook_menu(): used to create a page for the form
function nids_menu() {
  $items = array();
  $items['cour'] = array(
    'title'           => t('Dans ta cour'),
    'description'     => t('Dans ta cour'),
    'menu_name'       => 'quastuvu1',
    'access arguments' => array('access content'),
    'weight'          => 3,
    'access callback' => 'user_access',
    'page callback' => 'quastuvu2_callback',
    'type' => MENU_NORMAL_ITEM,
    );
  $items['parc'] = array(
    'title'           => t('Dans un parc'),
    'description'     => t('Dans un parc'),
    'menu_name'       => 'quastuvu1',
    'access arguments' => array('access content'),
    'weight'          => 3,
    'access callback' => 'user_access',
    'page callback' => 'quastuvu3_callback',
    'type' => MENU_NORMAL_ITEM,
    );
  $items['ecole'] = array(
    'title'           => t("À une école"),
    'description'     => t('À une école'),
    'menu_name'       => 'quastuvu1',
    'access arguments' => array('access content'),
    'weight'          => 3,
    'access callback' => 'user_access',
    'page callback' => 'nichoir_callback',
    'type' => MENU_NORMAL_ITEM,
    );

  $items['nichoir'] = array(
    'title'           => t('Dans ton nichoir'),
    'description'     => t('Dans ton nichoir'),
    'menu_name'       => 'quastuvu2',
    'access arguments' => array('access content'),
    'weight'          => 3,
    'access callback' => 'user_access',
    'page callback' => 'nichoir_callback',
    'type' => MENU_NORMAL_ITEM,
    );
  $items['nichoir_parc'] = array(
    'title'           => t('Dans un nichoir dans un parc'),
    'description'     => t('Dans un nichoir dans un parc'),
    'menu_name'       => 'quastuvu3',
    'access arguments' => array('access content'),
    'weight'          => 4,
    'access callback' => 'user_access',
    'page callback' => 'nichoir_parc_callback',
    'type' => MENU_NORMAL_ITEM,
    );

  $items['mangeoire_parc'] = array(
    'title'           => t('Dans une mangeoire dans un parc'),
    'description'     => t('Dans une mangeoire dans un parc'),
    'menu_name'       => 'quastuvu3',
    'access arguments' => array('access content'),
    'weight'          => 5,
    'access callback' => 'user_access',
    'page callback' => 'mangeoire_callback',
    'type' => MENU_NORMAL_ITEM,
    );
  $items['mangeoire'] = array(
    'title'           => t('Dans ta mangeoire'),
    'description'     => t('Dans ta mangeoire'),
    'menu_name'       => 'quastuvu2',
    'access arguments' => array('access content'),
    'weight'          => 5,
    'access callback' => 'user_access',
    'page callback' => 'mangeoire_callback',
    'type' => MENU_NORMAL_ITEM,
    );

  $items['cour_obs'] = array(
    'title'           => t('Oiseau observé dans ta cour'),
    'description'     => t('Dans ta cour'),
    'menu_name'       => 'quastuvu2',
    'access arguments' => array('access content'),
    'weight'          => 6,
    'access callback' => 'user_access',
    'page callback' => 'cour_callback',
    'type' => MENU_NORMAL_ITEM,
    );

  $items['observation'] = array(
    'title'           => t('Ajouter une observation'),
    'description'     => t('Dans ta cour'),
    'menu_name'       => 'main-menu',
    'access arguments' => array('access content'),
    'weight'          => 7,
    'access callback' => 'user_access',
    'page callback' => 'quastuvu1_callback',
    'type' => MENU_NORMAL_ITEM,
    );

  $items['ajout_nichoir'] = array(
    'title'           => t('Ajouter un nichoir'),
    'description'     => t('Ajouter un nichoir'),
    'menu_name'       => 'main-menu',
    'access arguments' => array('access content'),
    'weight'          => 5,
    'access callback' => 'user_access',
    'page callback' => 'ajout_nichoir_callback',
    'type' => MENU_NORMAL_ITEM,
    );

  $items['inscription'] = array(
    'title'           => t("S'inscrire"),
    'description'     => t('Inscription'),
    'menu_name'       => 'main-menu',
    'access arguments' => array('access content'),
    'weight'          => 4,
    'access callback' => 'user_access',
    'page callback' => 'inscription_callback',
    'type' => MENU_NORMAL_ITEM,
    );


  $items['nids/coordinate_conversion'] = array(
    'page callback' => 'nids_coordinate_conversion_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    );


  return $items;
}

function nids_preprocess_page(&$variables) {
  drupal_add_library('system', 'ui');
  drupal_add_library('system', 'ui.accordion');
  drupal_add_library('system', 'ui.autocomplete');
  drupal_add_library('system', 'ui.button');
  drupal_add_library('system', 'ui.datepicker');
  drupal_add_library('system', 'ui.dialog');
  drupal_add_library('system', 'ui.draggable');
  drupal_add_library('system', 'ui.droppable');
  drupal_add_library('system', 'ui.mouse');
  drupal_add_library('system', 'ui.position');
  drupal_add_library('system', 'ui.progressbar');
  drupal_add_library('system', 'ui.resizable');
  drupal_add_library('system', 'ui.selectable');
  drupal_add_library('system', 'ui.slider');
  drupal_add_library('system', 'ui.sortable');
  drupal_add_library('system', 'ui.tooltip');
  drupal_add_library('system', 'ui.tabs');
  drupal_add_library('system', 'ui.widget');
  $module_path = base_path().drupal_get_path('module', 'nids');
  drupal_add_js($module_path . '/javascript/nids.jqueryui_menu.js');
}

function nids_form_alter(&$form, &$form_state, $form_id) {

  if($form_id == 'nichoir_node_form') {

    drupal_add_js(array('nids_mode' => 'edit'), 'setting');

    $form['geo'] = array(
      '#title' => t(''),
      '#type' => 'fieldset',
      );
    $form['geo']['location_name'] = array(
      '#title' => t('Entre ton adresse (e.g. 21 Saint-Germain Ouest, Rimouski, G5L 4B4)'),
      '#type' => 'hidden',
      '#size' => 100,
      '#required' => FALSE,
      '#prefix' => '<div class="nidsbox"><h2>'.t('Lieu du nichoir').'</h2>',
      //'#suffix' => '<div id="noloc" style="display:none;">'.t('Ce nom ne peut être reconnu!').'</div><button type="button" id="addbynamebut">'.t('Ajouter un marqueur à cet endroit sur la carte (OPTION 1)').'</button>',
      '#default_value' => isset($form['#node']->nichoir['site_details']['location_name']) ? $form['#node']->nichoir['site_details']['location_name'] : ""
      );

    $form['geo']['geography'] = array(
      '#title' => t('Lieu du nichoir'),
      '#type' => 'hidden',
      '#size' => 200,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->nichoir['site_details']['geography']) ? $form['#node']->nichoir['site_details']['geography'] : "",
      '#suffix' => '<p>'.t('ou, si vous les connaissez, ajouter les coordonnées géographiques du nichoir en format latitude, longitude dans cette boîte (e.g. 48.3732, -68.7041).').'
      <br><input type="text" id="inputcoords" style="display:inline;width:200px;">
      <button type="button" id="inputcoordsbut" class="nids-button" style="display:inline;" >'.t('Ajouter un marqueur à cette position sur la carte').'</button>
      <div id="coorderror" style="display:none;">'.t('Coordonnées non reconnues!').'</div>
    </p>',
    '#prefix' => '<h3>'.t('Situe le nichoir directement sur la carte').'</h3><p>
    <button type="button" id="pointbut">'.t('Ajoute un nichoir en cliquant sur la carte').'</button>
    <button type="button" id="nids-clear">'.t('Effacer').'</button>
  </p>
  <div id="map" style="width:700px;height:500px;"></div></div>'
  );

$form['date'] = array(
  '#type' => 'date_popup',
  '#date_format' => 'Y-m-d',
  '#size' => 30,
  '#title' => "Date de l'installation du nichoir",
  '#required' => TRUE,
  );

$form['numero'] = array(
  '#title' => t("Quel est le numéro du nichoir?"),
  '#type' => 'textfield',
  '#required' => TRUE,
  '#default_value' => '',
  );

$form['habitat'] = array(
  '#title' => t("Le nichoir est fixé à..."),
  '#type' => 'select',
  '#required' => TRUE,
  '#default_value' => '',
  '#options' => array(
    'choisir' => 'Choisir...',
    'batiment' => 'bâtiment',
    'arbre' => 'arbre',
    'cloture' => 'clôture',
    'poteau' => 'poteau',
    ),
  );

$form['hauteur'] = array(
  '#title' => t("À quelle hauteur est situé le nichoir (en mètres)?"),
  '#type' => 'textfield',
  '#required' => TRUE,
  '#default_value' => '',
  '#size'=> 30,
  );

$form['orientation'] = array(
  '#title' => t("Orientation du nichoir"),
  '#type' => 'select',
  '#options' => array(
    'Choisir' => 'Choisir...',
    'Nord' => 'Nord',
    'Sud' => 'Sud',
    'Est' => 'Est',
    'Ouest' => 'Ouest',
    'Nord_est' => 'Nord-Est',
    'Nord_ouest' => 'Nord-Ouest',
    'Sud_est' => 'Sud-Est',
    'Sud_ouest' => 'Sud-Ouest',
    'Inconnue' => 'Inconnue',
    ),
  '#required' => TRUE,
  '#default_value' => 'Choisir',
  );

$module_path = base_path().drupal_get_path('module', 'nids');

$js_files = array(
  'http://maps.google.com/maps/api/js?sensor=false',
  $module_path . '/javascript/nids.map.js',
  $module_path . '/javascript/selectboxit.js',
  $module_path . '/javascript/nids.jqueryui.js',      
  );
$form['#attached']['js'] = $js_files;
$form['#validate'][] = 'nichoir_form_validate';
$form['#submit'][] = 'nichoir_form_submit';
$form['additional_settings']['#access'] = FALSE;
$form['options']['status']['#default_value'] = TRUE;
$form['options']['status']['#input'] = TRUE;
$form['options']['status']['#return_value'] = TRUE;
$form['options']['status']['#value'] = TRUE;
$form['options']['status']['#checked'] = TRUE;
drupal_set_title(t("Ajouter un nichoir"));
return $form;

}else if($form_id == 'user_register_form') {

  $form['type_utilisateur'] = array(
    '#title' => t("S'insrire en tant que..."),
    '#type' => 'select',
    '#options' => array(
      'enfant' => 'Enfant',
      'representant_scolaire' => 'Représentant scolaire',
      'citoyen' => 'Citoyen',
      'chercheur' => 'Chercheur scientifique',
      ),
    '#required' => TRUE,
    '#default_value' => 'Choisir',
    );

  $form['ecole'] = array(
    '#title' => t("Nom de l'école"),
    '#type' => 'select',
    '#options' => array(
      'Choisir' => 'Choisir...',
      'rose_des_vents' => 'École Rose des Vents',
      'des_sources' => 'École des Sources',
      'du_rocher_auteuil' => 'École du Rocher-Auteuil',
      'des_sources' => 'École Mont Saint-Louis',
      'saint_rosaire' => 'École Saint-Rosaire',
      ),
    '#required' => FALSE,
    '#states' => array(
      'visible' => array(
        ':input[name="type_utilisateur"]' => array(
          array('value' => 'enfant'),
          array('value' => 'representant_scolaire'),
          ),
        ),
      ),
    );
  $form['prenom'] = array(
    '#title' => t("Prénom"),
    '#type' => 'textfield',
    '#required' => TRUE,
    '#default_value' => '',
    '#size'=> 30,
    );
  $form['nom_famille'] = array(
    '#title' => t("Nom de famille"),
    '#type' => 'textfield',
    '#required' => TRUE,
    '#default_value' => '',
    '#size'=> 30,
    );
  $form['telephone'] = array(
    '#title' => t("Numéro de téléphone (optionnel)"),
    '#type' => 'textfield',
    '#required' => FALSE,
    '#default_value' => '',
    '#size'=> 30,
    );

  $form['adresse'] = array(
    '#title' => t("Adresse"),
    '#type' => 'fieldset',
    '#required' => FALSE,
    '#default_value' => '',
    '#size'=> 30,
    '#tree' =>FALSE,
    );
  $form['adresse']['adresse_civique'] = array(
    '#title' => t("Numéro civique et rue (ex. 145 rue Chambord)"),
    '#type' => 'textfield',
    '#required' => FALSE,
    '#default_value' => '',
    '#size'=> 30,
    );
  $form['adresse']['adresse_appt'] = array(
    '#title' => t("Appartement (si applicable)"),
    '#type' => 'textfield',
    '#required' => FALSE,
    '#default_value' => '',
    '#size'=> 10,
    );
  $form['adresse']['adresse_ville'] = array(
    '#title' => t("Ville"),
    '#type' => 'textfield',
    '#required' => FALSE,
    '#default_value' => '',
    '#size'=> 30,
    );
  $form['adresse']['adresse_code_postal'] = array(
    '#title' => t("Code postal"),
    '#type' => 'textfield',
    '#required' => FALSE,
    '#default_value' => '',
    '#size'=> 30,
    );
  return $form;
}
}



// Form builder. Form ID = function name
function nids_obsnichoir_form($form, &$form_state) {

  $form['nichoir'] = array(
    '#title' => t("Pour quel nichoir?"),
    '#type' => 'select',
    '#options' => array(
      'Choisir' => 'Choisir...',
      123 => 123,
      221 => 221,
      ),
    '#required' => TRUE,
    '#default_value' => 'Choisir',
    );

  $form['date'] = array(
    '#type' => 'date_popup',
    '#date_format' => 'Y-m-d H:i',
    '#size' => 30,
    '#title' => "Date et heure de l'observation",
    '#required' => TRUE,
    '#states' => array(
      'visible' => array(
        ':input[name="nichoir"]' => array('!value' => 'Choisir'),
        ),
      ),
    );

  $form['esp'] = array(
    '#title' => t("Quelle espèce?"),
    '#type' => 'select',
    '#options' => array(
      'Choisir' => 'Choisir...',
      'Moineau_domestique' => 'Moineau domestique',
      'Hirondelle_bicolore' => 'Hirondelle bicolore',
      'Mesange_a_tete_noire' => 'Mésange à tête noire',
      'Mesange_brune' => 'Mésange brune',
      'Inconnue' => 'Inconnue',
      'Autre' => 'Autre'
      ),
    '#required' => TRUE,
    '#default_value' => 'Choisir',
    '#states' => array(
      'visible' => array(
        ':input[name="nichoir"]' => array('!value' => 'Choisir'),
        ),
      ),
    );


  $form['espece_autre'] = array(
    '#type' => 'textfield',
    '#size' => 70,
    '#title' => '<h4>'.t("Veuillez préciser l'espèce...").'</h4>',
    '#states' => array(
      'visible' => array(
        ':input[name="esp"]' => array('value' => 'Autre'),
        ':input[name="nichoir"]' => array('!value' => 'Choisir'),
        ),
      ),
    );

  $form['type_obs'] = array(
    '#title' => t("Type d'observation"),
    '#type' => 'radios',
    '#size' => 50,
    '#required' => FALSE,
    '#options' => array(
      1 => t('Entrée ou sortie du nichoir'),
      2 => t('Apport de brindilles'),
      3 => t("Accouplement"),
      4 => t('Sons de poussins, quémande alimentaire'),
      5 => t('Alimentation des poussins par les parents (bec avec des chenilles, etc.)'),
      6 => t('Chante sur ou proche du nichoir'),
      7 => t('Oiseau chante sur nichoir'),
      8 => t('Indiquer un nombre de visites au nichoir pendant 5 minutes'),
      9 => t('Autre'),
      ),
    '#states' => array(
      'visible' => array(
        ':input[name="esp"]' => array('!value' => 'Choisir'),
        ),
      ),

    );

  $form['type_obs_autre'] = array(
    '#type' => 'textfield',
    '#size' => 70,
    '#title' => '<h4>'.t("Veuillez préciser...").'</h4>',
    '#states' => array(
      'visible' => array(
        ':input[name="type_obs"]' => array('value' => 10),
        ':input[name="esp"]' => array('!value' => 'Choisir'),
        ),
      ),
    );

  $form['nombre_visite'] = array(
    '#type' => 'textfield',
    '#size' => 70,
    '#title' => '<h4>'.t("Indiquer le nombre de visites au nichoir enregistrées pendant une période de 5 minutes...").'</h4>',
    '#states' => array(
      'visible' => array(
        ':input[name="type_obs"]' => array('value' => 9),
        ':input[name="esp"]' => array('!value' => 'Choisir'),
        ),
      ),
    );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t("Ajouter l'observation!"),
    '#states' => array(
      'visible' => array(
        ':input[name="type_obs"]' => array('!value' => false),
        ':input[name="esp"]' => array('!value' => 'Choisir'),
        ),
      ),
    '#suffix' => '<div style="height:100px;"></div>',
    );

  $module_path = base_path().drupal_get_path('module', 'nids');

  $js_files = array(
    $module_path . '/javascript/nids.jqueryui.js',
    $module_path . '/javascript/selectboxit.js',
    );
  $form['#attached']['js'] = $js_files;
  $form['#validate'][] = 'nids_form_validate';
  $form['#submit'][] = 'nids_form_submit';
  $form['title']['#title'] = 'Ajouter un nichoir';
  return $form;
}

function nids_obsmangeoire_form($form, &$form_state) {

  $form['date'] = array(
    '#type' => 'date_popup',
    '#date_format' => 'Y-m-d H:i',
    '#size' => 30,
    '#title' => "Date et heure de l'observation",
    '#required' => FALSE,
    );

  $form['nombre_visite'] = array(
    '#type' => 'textfield',
    '#size' => 10,
    '#title' => '<h4>'.t("Indiquer la durée de la période d'observation (en minutes)...").'</h4>',
    );

  $form['oiseau'] = array(
    '#type' => 'fieldset',
    '#title_display' => 'invisible',
    '#prefix' => '<div id="oiseaux-div">',
    '#suffix' => '</div>',
    '#tree' =>FALSE
    );

  $numoiseaux=0;
  if(array_key_exists('values',$form_state)){
    foreach ($form_state['values'] as $key => $value) {
      if (strpos($key,"espece_") !== false) {
        $numoiseaux++;
      }
    }
  }



  unset($form_state['input']['espece']);
  $form['oiseau']['espece'] = array(
    '#title' => t("Quelle espèce?"),
    '#type' => 'select',
    '#options' => array(
      "Espèces communes"=>array( //"--- Espèces communes ---",
      "Bruant à couronne blanche"=>"Bruant à couronne blanche",
      "Bruant à gorge blanche"=>"Bruant à gorge blanche",
      "Bruant chanteur"=>"Bruant chanteur",
      "Carouge à épaulette"=>"Carouge à épaulette",
      "Chardonneret jaune"=>"Chardonneret jaune",
      "Colibri à gorge rubis"=>"Colibri à gorge rubis",
      "Corneille d'Amérique"=>"Corneille d'Amérique",
      "Étourneau sansonnet"=>"Étourneau sansonnet",
      "Geai bleu"=>"Geai bleu",
      "Hirondelle bicolore"=>"Hirondelle bicolore",
      "Jaseur d'Amérique"=>"Jaseur d'Amérique",
      "Junco ardoisé"=>"Junco ardoisé",
      "Merle d'Amérique"=>"Merle d'Amérique",
      "Mésange à tête noire"=>"Mésange à tête noire",
      "Moineau domestique"=>"Moineau domestique",
      "Paruline è croupion jaune"=>"Paruline è croupion jaune",
      "Pic chevelu"=>"Pic chevelu",
      "Quiscale bronzé"=>"Quiscale bronzé",
      "Roselin pourpré"=>"Roselin pourpré",
      "Tourterelle triste"=>"Tourterelle triste",
      ),
      "Autres espèces"=>array(//"--- Autres espèces ---",
      "Alouette hausse-col"=>"Alouette hausse-col",
      "Autour des palombes"=>"Autour des palombes",
      "Avocette d'Amérique"=>"Avocette d'Amérique",
      "Balbuzard pêcheur"=>"Balbuzard pêcheur",
      "Bécasseau semipalmé"=>"Bécasseau semipalmé",
      "Bernache cravant"=>"Bernache cravant",
      "Bernache du Canada"=>"Bernache du Canada",
      "Bruant de Lincoln"=>"Bruant de Lincoln",
      "Bruant des prés"=>"Bruant des prés",
      "Bruant familier"=>"Bruant familier",
      "Bruant fauve"=>"Bruant fauve",
      "Bruant hudsonien"=>"Bruant hudsonien",
      "Busard St-Martin"=>"Busard St-Martin",
      "Buse à queue rousse"=>"Buse à queue rousse",
      "Buse pattue"=>"Buse pattue",
      "Canard arlequin"=>"Canard arlequin",
      "Canard colvert"=>"Canard colvert",
      "Canard d'Amérique"=>"Canard d'Amérique",
      "Canard noir"=>"Canard noir",
      "Canard pilet"=>"Canard pilet",
      "Chevalier grivelé"=>"Chevalier grivelé",
      "Chevalier solitaire"=>"Chevalier solitaire",
      "Cormorant à aigrette"=>"Cormorant à aigrette",
      "Crécerelle d'Amérique"=>"Crécerelle d'Amérique",
      "Eider à duvet"=>"Eider à duvet",
      "Eider à tête grise"=>"Eider à tête grise",
      "Épervier brun"=>"Épervier brun",
      "Faucon émerillon"=>"Faucon émerillon",
      "Faucon pèlerin"=>"Faucon pèlerin",
      "Fou de Bassan"=>"Fou de Bassan",
      "Fuligule à collier"=>"Fuligule à collier",
      "Fuligule milouinan"=>"Fuligule milouinan",
      "Garrot à œil d'or"=>"Garrot à œil d'or",
      "Garrot d'Islande"=>"Garrot d'Islande",
      "Gélinotte huppé"=>"Gélinotte huppé",
      "Goéland à bec cerclé"=>"Goéland à bec cerclé",
      "Goéland arctique"=>"Goéland arctique",
      "Goéland argenté"=>"Goéland argenté",
      "Goéland bourgmestre"=>"Goéland bourgmestre",
      "Goéland marin"=>"Goéland marin",
      "Grand Chevalier"=>"Grand Chevalier",
      "Grand Corbeau"=>"Grand Corbeau",
      "Grand Harle"=>"Grand Harle",
      "Grand Heron"=>"Grand Heron",
      "Grand Pic"=>"Grand Pic",
      "Grèbe à bec bigarré"=>"Grèbe à bec bigarré",
      "Grèbe jougris"=>"Grèbe jougris",
      "Grive à dos olive"=>"Grive à dos olive",
      "Grive fauve"=>"Grive fauve",
      "Grive solitaire"=>"Grive solitaire",
      "Gros-bec errant"=>"Gros-bec errant",
      "Guillemot à miroir"=>"Guillemot à miroir",
      "Harelde kakawi"=>"Harelde kakawi",
      "Harle couronné"=>"Harle couronné",
      "Harle huppé"=>"Harle huppé",
      "Hirondelle rustique"=>"Hirondelle rustique",
      "Jaseur boréal"=>"Jaseur boréal",
      "Macareux moine"=>"Macareux moine",
      "Macreuse à bec jaune"=>"Macreuse à bec jaune",
      "Macreuse à front blanc"=>"Macreuse à front blanc",
      "Macreuse brune"=>"Macreuse brune",
      "Martin-pêcheur d'Amérique"=>"Martin-pêcheur d'Amérique",
      "Merlebleu de l'Est"=>"Merlebleu de l'Est",
      "Mésange à tête brune"=>"Mésange à tête brune",
      "Mésangeai du Canada"=>"Mésangeai du Canada",
      "Moqueur chat"=>"Moqueur chat",
      "Moucherolle tchébec"=>"Moucherolle tchébec",
      "Oie des neiges"=>"Oie des neiges",
      "Paruline à calotte noire"=>"Paruline à calotte noire",
      "Paruline à collier"=>"Paruline à collier",
      "Paruline à gorge noire"=>"Paruline à gorge noire",
      "Paruline à tête cendrée"=>"Paruline à tête cendrée",
      "Paruline bleue"=>"Paruline bleue",
      "Paruline des ruisseaux"=>"Paruline des ruisseaux",
      "Paruline flamboyant"=>"Paruline flamboyant",
      "Paruline jaune"=>"Paruline jaune",
      "Paruline masquée"=>"Paruline masquée",
      "Paruline noir et blanc"=>"Paruline noir et blanc",
      "Paruline obscur"=>"Paruline obscur",
      "Paruline tigrée"=>"Paruline tigrée",
      "Petit Garrot"=>"Petit Garrot",
      "Pic flamboyant"=>"Pic flamboyant",
      "Pic maculé"=>"Pic maculé",
      "Pic mineur"=>"Pic mineur",
      "Pie-grièche grise"=>"Pie-grièche grise",
      "Pigeon biset"=>"Pigeon biset",
      "Pipit d'Amérique"=>"Pipit d'Amérique",
      "Plectrophane des neiges"=>"Plectrophane des neiges",
      "Plectrophane lapon"=>"Plectrophane lapon",
      "Plongeon catmarin"=>"Plongeon catmarin",
      "Plongeon huard"=>"Plongeon huard",
      "Pluvier kildir"=>"Pluvier kildir",
      "Pluvier semipalmé"=>"Pluvier semipalmé",
      "Pypargue à tête blanche"=>"Pypargue à tête blanche",
      "Roitelet à couronne dorée"=>"Roitelet à couronne dorée",
      "Roitelet à couronne rubis"=>"Roitelet à couronne rubis",
      "Roselin familier"=>"Roselin familier",
      "Sarcelle à ailes bleues"=>"Sarcelle à ailes bleues",
      "Sarcelle d'été"=>"Sarcelle d'été",
      "Sarcelle d'hiver"=>"Sarcelle d'hiver",
      "Sitelle à poitrine blanche"=>"Sitelle à poitrine blanche",
      "Sitelle à poitrine rousse"=>"Sitelle à poitrine rousse",
      "Sizerin blanchâtre"=>"Sizerin blanchâtre",
      "Sizerin flammé"=>"Sizerin flammé",
      "Tarin des pins"=>"Tarin des pins",
      "Tohi à flancs roux"=>"Tohi à flancs roux",
      "Troglodyte des forêts"=>"Troglodyte des forêts",
      "Troglodyte familier"=>"Troglodyte familier",
      "Urubu à tête rouge"=>"Urubu à tête rouge",
      "Vacher à tête brune"=>"Vacher à tête brune",
      "Viréo à tête bleue"=>"Viréo à tête bleue",
      "Viréo aux yeux rouges"=>"Viréo aux yeux rouges",
      ),
      ),
'#required' => TRUE,
'#multiple' => TRUE,
'#size' => 10,
'#default_value' => 'Choisir',
'#prefix' => '<div class="sameline">',
'#suffix' => '</div>',
'#states' => array(
  'visible' => array(
    ':input[name="mangeoire"]' => array('!value' => 'Choisir'),
    ),
  ),
);

unset($form_state['input']['nombre_individus']);
$form['oiseau']['nombre_individus'] = array(
  '#type' => 'textfield',
  '#size' => 10,
  '#title' => '<h4>'.t("Indiquer le nombre maximal d'individus observés (approximatif pour les grands nombres)").'</h4>',
  '#states' => array(
    'visible' => array(
      ':input[name="espece"]' => array('!value' => 'Choisir'),
      ),
    ),
  );

$form['ajout_espece'] = array(
  '#type' => 'submit',
  '#value' => t("Autre espèce observée"),
  '#states' => array(
    'visible' => array(
      ':input[name="espece"]' => array('!value' => 'Choisir'),
      ),
    ),
  '#executes_submit_callback' => FALSE,
  '#ajax' => array(
    'callback' => 'ajax_ajout_oiseau_callback',
    'wrapper' => 'oiseaux-div',
    'method' => 'append',
    'effect' => 'fade',
    ),
  );



$form['submit'] = array(
  '#type' => 'submit',
  '#value' => t("Ajouter l'observation!"),
  '#states' => array(
    'visible' => array(
      ':input[name="espece"]' => array('!value' => 'Choisir'),
      ),
    ),
      '#suffix' => '<div style="height:100px;"></div>',
  );

$module_path = base_path().drupal_get_path('module', 'nids');

$js_files = array(
  $module_path . '/javascript/nids.jqueryui.js',
  $module_path . '/javascript/selectboxit.js',
  );
$form['#attached']['js'] = $js_files;
$form['#validate'][] = 'mangeoire_form_validate';
$form['#submit'][] = 'mangeoire_form_submit';
return $form;
}

function nids_obscour_form($form, &$form_state) {
  $form['date'] = array(
    '#type' => 'date_popup',
    '#date_format' => 'Y-m-d H:i',
    '#size' => 30,
    '#title' => "Date et heure de l'observation",
    '#required' => TRUE,
    );

  $form['rien_vu'] = array(
    '#title' => t("Je n'ai rien vu"),
    '#type' => 'checkbox',
    '#required' => FALSE,
    );

  $form['duree_obs'] = array(
    '#type' => 'textfield',
    '#size' => 50,
    '#title' => '<h4>'.t("Indiquer la durée de l'observation (en minutes)...").'</h4>',
    '#states' => array(
      'visible' => array(
        ':input[name="rien_vu"]' => array('checked' => TRUE),
        ),
      ),
    );

  $form['oiseau'] = array(
    '#type' => 'fieldset',
    '#title_display' => 'invisible',
    '#prefix' => '<div id="oiseaux-div">',
    '#suffix' => '</div>',
    '#tree' =>FALSE
    );

  $numoiseaux=0;
  if(array_key_exists('values',$form_state)){
    foreach ($form_state['values'] as $key => $value) {
      if (strpos($key,"espece_") !== false) {
        $numoiseaux++;
      }
    }
  }



  unset($form_state['input']['espece']);
  $form['oiseau']['espece'] = array(
    '#title' => t("Quelle espèce?"),
    '#type' => 'select',
    '#options' => array(
      "Espèces communes"=>array( //"--- Espèces communes ---",
      "Bruant à couronne blanche"=>"Bruant à couronne blanche",
      "Bruant à gorge blanche"=>"Bruant à gorge blanche",
      "Bruant chanteur"=>"Bruant chanteur",
      "Carouge à épaulette"=>"Carouge à épaulette",
      "Chardonneret jaune"=>"Chardonneret jaune",
      "Colibri à gorge rubis"=>"Colibri à gorge rubis",
      "Corneille d'Amérique"=>"Corneille d'Amérique",
      "Étourneau sansonnet"=>"Étourneau sansonnet",
      "Geai bleu"=>"Geai bleu",
      "Hirondelle bicolore"=>"Hirondelle bicolore",
      "Jaseur d'Amérique"=>"Jaseur d'Amérique",
      "Junco ardoisé"=>"Junco ardoisé",
      "Merle d'Amérique"=>"Merle d'Amérique",
      "Mésange à tête noire"=>"Mésange à tête noire",
      "Moineau domestique"=>"Moineau domestique",
      "Paruline è croupion jaune"=>"Paruline è croupion jaune",
      "Pic chevelu"=>"Pic chevelu",
      "Quiscale bronzé"=>"Quiscale bronzé",
      "Roselin pourpré"=>"Roselin pourpré",
      "Tourterelle triste"=>"Tourterelle triste",
      ),
      "Autres espèces"=>array(//"--- Autres espèces ---",
      "Alouette hausse-col"=>"Alouette hausse-col",
      "Autour des palombes"=>"Autour des palombes",
      "Avocette d'Amérique"=>"Avocette d'Amérique",
      "Balbuzard pêcheur"=>"Balbuzard pêcheur",
      "Bécasseau semipalmé"=>"Bécasseau semipalmé",
      "Bernache cravant"=>"Bernache cravant",
      "Bernache du Canada"=>"Bernache du Canada",
      "Bruant de Lincoln"=>"Bruant de Lincoln",
      "Bruant des prés"=>"Bruant des prés",
      "Bruant familier"=>"Bruant familier",
      "Bruant fauve"=>"Bruant fauve",
      "Bruant hudsonien"=>"Bruant hudsonien",
      "Busard St-Martin"=>"Busard St-Martin",
      "Buse à queue rousse"=>"Buse à queue rousse",
      "Buse pattue"=>"Buse pattue",
      "Canard arlequin"=>"Canard arlequin",
      "Canard colvert"=>"Canard colvert",
      "Canard d'Amérique"=>"Canard d'Amérique",
      "Canard noir"=>"Canard noir",
      "Canard pilet"=>"Canard pilet",
      "Chevalier grivelé"=>"Chevalier grivelé",
      "Chevalier solitaire"=>"Chevalier solitaire",
      "Cormorant à aigrette"=>"Cormorant à aigrette",
      "Crécerelle d'Amérique"=>"Crécerelle d'Amérique",
      "Eider à duvet"=>"Eider à duvet",
      "Eider à tête grise"=>"Eider à tête grise",
      "Épervier brun"=>"Épervier brun",
      "Faucon émerillon"=>"Faucon émerillon",
      "Faucon pèlerin"=>"Faucon pèlerin",
      "Fou de Bassan"=>"Fou de Bassan",
      "Fuligule à collier"=>"Fuligule à collier",
      "Fuligule milouinan"=>"Fuligule milouinan",
      "Garrot à œil d'or"=>"Garrot à œil d'or",
      "Garrot d'Islande"=>"Garrot d'Islande",
      "Gélinotte huppé"=>"Gélinotte huppé",
      "Goéland à bec cerclé"=>"Goéland à bec cerclé",
      "Goéland arctique"=>"Goéland arctique",
      "Goéland argenté"=>"Goéland argenté",
      "Goéland bourgmestre"=>"Goéland bourgmestre",
      "Goéland marin"=>"Goéland marin",
      "Grand Chevalier"=>"Grand Chevalier",
      "Grand Corbeau"=>"Grand Corbeau",
      "Grand Harle"=>"Grand Harle",
      "Grand Heron"=>"Grand Heron",
      "Grand Pic"=>"Grand Pic",
      "Grèbe à bec bigarré"=>"Grèbe à bec bigarré",
      "Grèbe jougris"=>"Grèbe jougris",
      "Grive à dos olive"=>"Grive à dos olive",
      "Grive fauve"=>"Grive fauve",
      "Grive solitaire"=>"Grive solitaire",
      "Gros-bec errant"=>"Gros-bec errant",
      "Guillemot à miroir"=>"Guillemot à miroir",
      "Harelde kakawi"=>"Harelde kakawi",
      "Harle couronné"=>"Harle couronné",
      "Harle huppé"=>"Harle huppé",
      "Hirondelle rustique"=>"Hirondelle rustique",
      "Jaseur boréal"=>"Jaseur boréal",
      "Macareux moine"=>"Macareux moine",
      "Macreuse à bec jaune"=>"Macreuse à bec jaune",
      "Macreuse à front blanc"=>"Macreuse à front blanc",
      "Macreuse brune"=>"Macreuse brune",
      "Martin-pêcheur d'Amérique"=>"Martin-pêcheur d'Amérique",
      "Merlebleu de l'Est"=>"Merlebleu de l'Est",
      "Mésange à tête brune"=>"Mésange à tête brune",
      "Mésangeai du Canada"=>"Mésangeai du Canada",
      "Moqueur chat"=>"Moqueur chat",
      "Moucherolle tchébec"=>"Moucherolle tchébec",
      "Oie des neiges"=>"Oie des neiges",
      "Paruline à calotte noire"=>"Paruline à calotte noire",
      "Paruline à collier"=>"Paruline à collier",
      "Paruline à gorge noire"=>"Paruline à gorge noire",
      "Paruline à tête cendrée"=>"Paruline à tête cendrée",
      "Paruline bleue"=>"Paruline bleue",
      "Paruline des ruisseaux"=>"Paruline des ruisseaux",
      "Paruline flamboyant"=>"Paruline flamboyant",
      "Paruline jaune"=>"Paruline jaune",
      "Paruline masquée"=>"Paruline masquée",
      "Paruline noir et blanc"=>"Paruline noir et blanc",
      "Paruline obscur"=>"Paruline obscur",
      "Paruline tigrée"=>"Paruline tigrée",
      "Petit Garrot"=>"Petit Garrot",
      "Pic flamboyant"=>"Pic flamboyant",
      "Pic maculé"=>"Pic maculé",
      "Pic mineur"=>"Pic mineur",
      "Pie-grièche grise"=>"Pie-grièche grise",
      "Pigeon biset"=>"Pigeon biset",
      "Pipit d'Amérique"=>"Pipit d'Amérique",
      "Plectrophane des neiges"=>"Plectrophane des neiges",
      "Plectrophane lapon"=>"Plectrophane lapon",
      "Plongeon catmarin"=>"Plongeon catmarin",
      "Plongeon huard"=>"Plongeon huard",
      "Pluvier kildir"=>"Pluvier kildir",
      "Pluvier semipalmé"=>"Pluvier semipalmé",
      "Pypargue à tête blanche"=>"Pypargue à tête blanche",
      "Roitelet à couronne dorée"=>"Roitelet à couronne dorée",
      "Roitelet à couronne rubis"=>"Roitelet à couronne rubis",
      "Roselin familier"=>"Roselin familier",
      "Sarcelle à ailes bleues"=>"Sarcelle à ailes bleues",
      "Sarcelle d'été"=>"Sarcelle d'été",
      "Sarcelle d'hiver"=>"Sarcelle d'hiver",
      "Sitelle à poitrine blanche"=>"Sitelle à poitrine blanche",
      "Sitelle à poitrine rousse"=>"Sitelle à poitrine rousse",
      "Sizerin blanchâtre"=>"Sizerin blanchâtre",
      "Sizerin flammé"=>"Sizerin flammé",
      "Tarin des pins"=>"Tarin des pins",
      "Tohi à flancs roux"=>"Tohi à flancs roux",
      "Troglodyte des forêts"=>"Troglodyte des forêts",
      "Troglodyte familier"=>"Troglodyte familier",
      "Urubu à tête rouge"=>"Urubu à tête rouge",
      "Vacher à tête brune"=>"Vacher à tête brune",
      "Viréo à tête bleue"=>"Viréo à tête bleue",
      "Viréo aux yeux rouges"=>"Viréo aux yeux rouges",
      ),
      ),
'#required' => TRUE,
'#multiple' => TRUE,
'#size' => 10,
'#default_value' => 'Choisir',
'#prefix' => '<div class="sameline">',
'#suffix' => '</div>',
);

unset($form_state['input']['nombre_individus']);
$form['oiseau']['nombre_individus'] = array(
  '#type' => 'textfield',
  '#size' => 10,
  '#title' => '<h4>'.t("Indiquer le nombre maximal d'individus observés (approximatif pour les grands nombres)").'</h4>',
  '#states' => array(
    'visible' => array(
      ':input[name="espece"]' => array('!value' => 'Choisir'),
      ),
    ),
  );

$form['ajout_espece'] = array(
  '#type' => 'submit',
  '#value' => t("Autre espèce observée"),
  '#states' => array(
    'visible' => array(
      ':input[name="espece"]' => array('!value' => 'Choisir'),
      ),
    ),
  '#executes_submit_callback' => FALSE,
  '#ajax' => array(
    'callback' => 'ajax_ajout_oiseau_callback',
    'wrapper' => 'oiseaux-div',
    'method' => 'append',
    'effect' => 'fade',
    ),
  );





  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t("Ajouter l'observation!"),
    '#suffix' => '<div style="height:100px;"></div>',
    );

  $module_path = base_path().drupal_get_path('module', 'nids');

  $js_files = array(
    $module_path . '/javascript/nids.jqueryui.js',
    $module_path . '/javascript/selectboxit.js',
    );
  $form['#attached']['js'] = $js_files;
  $form['#validate'][] = 'cour_form_validate';
  $form['#submit'][] = 'cour_form_submit';
  return $form;
}



// Form validation handler.
function nichoir_form_validate($form, &$form_state) {
  //do validation here if necessary
}

// Form submit handler.
function nichoir_form_submit($form, &$form_state) {
}

// Form validation handler.
function mangeoire_form_validate($form, &$form_state) {
  //do validation here if necessary
}

// Form submit handler.
function mangeoire_form_submit($form, &$form_state) {
}

// Form validation handler.
function cour_form_validate($form, &$form_state) {
  //do validation here if necessary
}

// Form submit handler.
function cour_form_submit($form, &$form_state) {
}



function nichoir_insert($node) {
}

function nichoir_update($node) {
}

function nichoir_delete($node) {
}

function nichoir_load($nodes) {
}

function _nids_fields($node) {
}



/**
 * Implements hook_block_info().
 */
function nids_block_info() {
}

/**
 * Implements hook_block_view().
 */
function nids_block_view($block_name = '') {
}

function quastuvu1_callback(){
  return menu_tree('quastuvu1');
}

function quastuvu2_callback(){
  return menu_tree('quastuvu2');
}

function quastuvu3_callback(){
  return menu_tree('quastuvu3');
}

function quastuvu4_callback(){
  return drupal_get_form('nids_obscour_form');
}


function nichoir_callback(){
  //$block = module_invoke('nids', 'block_view', 'form_nichoir');
  return drupal_get_form('nids_obsnichoir_form');//$block['content'];
}

function nichoir_parc_callback(){
  //$block = module_invoke('nids', 'block_view', 'form_nichoir');
  return drupal_get_form('nids_obsnichoir_form');//$block['content'];
}

function mangeoire_callback(){
  return drupal_get_form('nids_obsmangeoire_form');
}

function cour_callback(){
  return drupal_get_form('nids_obscour_form');
}

function ajout_nichoir_callback(){
  module_load_include('inc', 'node', 'node.pages');
  $form = node_add('nichoir'); 
  return drupal_render($form);
}

function inscription_callback(){
  $form = drupal_get_form('user_register_form');
  return drupal_render($form);
}

function ajax_ajout_oiseau_callback($form, $form_state) {
  return $form['oiseau'];
}


function nids_coordinate_conversion_callback($string = "") {
  $converted_coordinates = array();
  $input = ($string) ? $string : _remove_empty_lines($_POST['coordinates']);
  $coordinates = explode("\n", $input);
  foreach($coordinates as $coordinate) {
    if(!array_key_exists($coordinate, $converted_coordinates)) {
      $converted = _make_coordinates($coordinate);
      $status = (_check_coordinate($converted)) ? 'success' : 'fail';
      $converted_coordinates[$coordinate] = array(
        'status' => $status,
        'converted' => $converted
        );
    }
  }
  drupal_json_output($converted_coordinates);
}

function _remove_empty_lines($string) {
  return preg_replace("/(^[\r\n]*|[\r\n]+)[\s\t]*[\r\n]+/", "\n", $string);
}

function _make_coordinates($point) {
  $loc = preg_replace('/\t/', '|', $point); //replace tabs with pipes
  $loc = preg_replace('/[\p{Z}\s]/u', ' ', $loc); //remove all extra spaces
  $loc = trim(preg_replace('/[^\|\d\s,;.\-NSEWO°ºdms\'"]/i', '', $loc));
  if(preg_match('/[NSEWO]/', $loc) != 0) {
    $coord = preg_split("/[\|,;]/", $loc); //split the coords by a pipe, comma, semicolon
    if (!array_key_exists(1, $coord)) { return array(null, null); }
    $coord = (preg_match('/[EWO]/', $coord[1]) != 0) ? $coord : array_reverse($coord);
    return array(_dms_to_deg(trim($coord[0])),_dms_to_deg(trim($coord[1])));
  } else {
    return preg_split("/[\|\s,;]+/",$loc); //split the coords by a pipe, space, comma, semicolon
  }
}


function _dms_to_deg($dms) {
  $dms = stripslashes($dms);
  $neg = (preg_match('/[SWO]/i', $dms) == 0) ? 1 : -1;
  $dms = preg_replace('/(^\s?-)|(\s?[NSEWO]\s?)/i','', $dms);
  $pattern = "/(\\d*\\.?\\d+)(?:[°ºd: ]+)(\\d*\\.?\\d+)*(?:['m′: ])*(\\d*\\.?\\d+)*[\"s″ ]?/i";
  $parts = preg_split($pattern, $dms, 0, PREG_SPLIT_NO_EMPTY | PREG_SPLIT_DELIM_CAPTURE);
  if (!$parts) { return; }
  // parts: 0 = degree, 1 = minutes, 2 = seconds
  $d = isset($parts[0]) ? (float)$parts[0] : 0;
  $m = isset($parts[1]) ? (float)$parts[1] : 0;
  if(strpos($dms, ".") > 1 && isset($parts[2])) {
    $m = (float)($parts[1] . '.' . $parts[2]);
    unset($parts[2]);
  }
  $s = isset($parts[2]) ? (float)$parts[2] : 0;
  $dec = ($d + ($m/60) + ($s/3600))*$neg; 
  return $dec;
}

function _check_coordinate($coord) {
  $output = false;
  if(is_numeric($coord[0])
    && is_numeric($coord[1])
    && $coord[0] <= 90 
    && $coord[0] >= -90 
    && $coord[1] <= 180 
    && $coord[1] >= -180) { $output = true; }
    return $output;
}


?>
